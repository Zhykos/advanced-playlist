name: CI

on:
  push:
    branches: [ latest ]
  schedule:
    - cron:  '0 0 * * MON'

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox]
    environment: tests
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14.x
        cache: 'npm'
    - run: npm ci
    - name: Install ChromeDriver for Ubuntu
      run: npm install chromedriver@96.0.0
    - name: Launch tests
      env:
        YT_CLIENT_API_KEY: ${{ secrets.CLIENT_API_KEY }}
        YT_CLIENT_ID: ${{ secrets.CLIENT_ID }}
      run: |
        export CLIENT_API_KEY=$YT_CLIENT_API_KEY
        export CLIENT_ID=$YT_CLIENT_ID
        SUMMARY="$(npm run ${{ matrix.browser }}-tests | tail -2 | head -1)"
        TOKENS=($SUMMARY)
        echo "COVERAGE=$(echo ${TOKENS[2]})" >> $GITHUB_ENV

    # Coverage badge: https://dev.to/thejaredwilcurt/coverage-badge-with-github-actions-finally-59fa
    # Only run the coverage once
    - if: ${{ matrix.browser == 'chrome' }}
      name: Get Coverage for badge
      run: |
        # var SUMMARY = [
        #   '',
        #   '=============================== Coverage summary ===============================',
        #   'Statements   : 32.5% ( 39/120 )',
        #   'Branches     : 38.89% ( 21/54 )',
        #   'Functions    : 21.74% ( 5/23 )',
        #   'Lines        : 31.93% ( 38/119 )',
        #   '================================================================================',
        #   ''
        # ];
        # SUMMARY = SUMMARY.split('\n')[5]; // 'Lines        : 31.93% ( 38/119 )'
        # SUMMARY = SUMMARY.split(':')[1].split('(')[0].trim(); // '31.93%'
        #SUMMARY="$(npm test -- --coverageReporters='text-summary' | tail -2 | head -1)"
        #TOKENS=($SUMMARY)
        # process.env.COVERAGE = '31.93%';
        #echo "COVERAGE=$(echo ${TOKENS[2]})" >> $GITHUB_ENV

        # var REF = 'refs/pull/27/merge.json';
        REF=${{ github.ref }}
        # console.log('github.ref: ' + REF);
        echo "github.ref: $REF"
        # var PATHS = REF.split('/');
        IFS='/' read -ra PATHS <<< "$REF"
        # var BRANCH_NAME = PATHS[1] + PATHS[2];
        BRANCH_NAME="${PATHS[1]}_${PATHS[2]}"
        # console.log(BRANCH_NAME); // 'pull_27'
        echo $BRANCH_NAME
        # process.env.BRANCH = 'pull_27';
        echo "BRANCH=$(echo ${BRANCH_NAME})" >> $GITHUB_ENV
    - if: ${{ matrix.browser == 'chrome' }}
      name: Create the Badge
      uses: schneegans/dynamic-badges-action@v1.0.0
      with:
        auth: ${{ secrets.GIST }}
        gistID: 1e17cccbecd6e44805d33ee6a300e44b
        filename: fr.zhykos.videocustomfeed_latest.json
        label: Test Coverage
        message: ${{ env.COVERAGE }} %
        color: green
        namedLogo: jest
        style: flat-square

    - if: ${{ matrix.browser == 'chrome' }}
      name: Create release zip
      run: |
        cd packaging
        ./package.sh 1.0.1-dev